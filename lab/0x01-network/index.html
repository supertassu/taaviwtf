<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>[0x01] The lab network &ndash;
taavi.wtf</title><meta property=og:site_name content=taavi.wtf><meta property=og:title content="[0x01] The lab network"><meta property=og:description content="As explained in the the series overview, I use the lab to experiement with enterprise gear so my home network is - let&rsquo;s say - advanced.
The hardware My router is a HP desktop I got for free running pfSense. I installed a second NIC in it. Any PC should work.
My main switch is a 1st gen Unifi US-24 featuring 24 1Gb RJ45 ports and 2 1Gb SFP ports."><meta property=og:type content=article><meta property=og:url content=https://taavi.wtf/lab/0x01-network/><meta property=article:published_time content=2019-02-01T00:00:00+00:00><meta property=article:modified_time content=2019-02-01T00:00:00+00:00><link rel=stylesheet href=https://taavi.wtf/css/styles.min.b05c93174586d85f9dc92eb4e4c3e96aca2e4cf177ecaeace816a340c507b9e2.css integrity="sha256-sFyTF0WG2F&#43;dyS605MPpasouTPF37K6s6BajQMUHueI="></head><body class="bg-black text-white font-mono border-t-8 border-pink-700"><div class="container mx-auto max-md:px-4"><header class="w-full py-12"><nav class="flex justify-between"><div><a href=https://taavi.wtf/ class="bg-pink-700 p-2 hover:underline">taavi.wtf</a></div><div class=flex><a href=https://taavi.wtf/posts/ class="link mx-2 hover:text-pink-400">Blog</a>
<a href=https://taavi.wtf/lab/ class="link mx-2 hover:text-pink-400">Lab</a></div></nav></header><article class=text-gray-400><h1 class="font-bold text-4xl text-gray-300">[0x01] The lab network</h1><p><span class=text-pink-700>►</span> Written on <span class="text-white font-bold">February 1, 2019</span>.</p><div class=rich-text><p>As explained in the <a href=https://taavi.wtf/lab/0x00-overview/>the series overview</a>, I use the lab to experiement with enterprise gear so my home network is - let&rsquo;s say - advanced.</p><h2 id=the-hardware>The hardware</h2><p>My router is a HP desktop I got for free running pfSense. I installed a second NIC in it. Any PC should work.</p><p>My main switch is a 1st gen <a href=https://store.ui.com/products/unifi-switch-24>Unifi US-24</a> featuring 24 1Gb RJ45 ports and 2 1Gb SFP ports. I didn&rsquo;t buy the PoE version due to budget constraints. It&rsquo;s managed via the Unifi controller that I have running on a VM on my hypervisor.</p><p>For Wi-Fi, I have an <a href=https://store.ui.com/products/unifi-ac-lite>Unifi UAP-AC-LITE</a>. Because my switch doesn&rsquo;t have PoE ports, I use the included PoE injector to power it.</p><h2 id=the-routing>The routing</h2><p>As mentioned previously, I use pfSense for routing. It&rsquo;s really simple to install: create an USB stick with the ISO file, boot router from it, install files, setup a LAN range and some other options (usually the defaults are fine).</p><p>For my LAN, I use <code>10.20.0.1/24</code> (do not use <code>192.168.0.1/24</code> or <code>192.168.1.1/24</code> for reasons). I use the LAN for management and networking devices (routers, switches) only and create VLANs for clients.</p><p>I have four VLANs: <code>10</code> for users, <code>20</code> for the &ldquo;lab&rdquo; devices, <code>30</code> for IoT stuff and <code>40</code> for guests. They all exist in various ranges under <code>10.20.0.0/16</code>, usually either <code>10.20.[VLANID].0/24</code> or a <code>/21</code> so that <code>10.20.[VLANID].1</code> is in it. They all have some space for DHCP and some for static devices.</p><p>I have two Windows Server 2019 VMs running DHCP. They are set up for a 50%-50% load balance and both can handle full load if the other needs to shut down. In pfSense, I set up the DHCP relay (under Services menu) to point to these 2 VMs for multi-VLAN operation. I use my AD domain controllers for DNS (just point DNS to DC IPs, it&rsquo;s really that simple) and a separate VM running Network Policy and Access Services for <a href=https://en.wikipedia.org/wiki/IEEE_802.1X>802.1x</a> authentication for WiFi and Ethernet.</p><p><img src=/img/dhcp-load-balance.png alt="DHCP load balance settings">
<span class="text-sm text-gray-500">DHCP load balance settings</span></p><h3 id=firewalling>Firewalling</h3><p>My firewall rules in a nutshell:</p><ul><li>Trusted users in VLAN <code>10</code> can access anything except the LAN net</li><li>Lab devices in VLAN <code>20</code> can get out, to VLAN <code>30</code> (IoT) and use ICMP and UDP port 161 (SNMP) to LAN and VLAN <code>10</code> (users).</li><li>IoT devices in VLAN <code>30</code> can get out (I should restrict these, but I haven&rsquo;t found the time) and access my MQTT broker in my home assistant server.</li><li>Guests in VLAN <code>40</code> can get out but basically nothing else.</li></ul><h2 id=the-switching>The switching</h2><p>On my switch (1st gen Unifi US-24), I have two trunk ports (upstream and for the AP), one LAN/management port for emergenices, and then designated some ports for the Lab VLAN. The rest are <a href=https://en.wikipedia.org/wiki/IEEE_802.1X>802.1x</a> ports that authenticate users via Active Directory NPAS (I&rsquo;ll write about my AD setup later).</p><h2 id=the-ap>The AP</h2><p>On the Unifi AP that I have, I&rsquo;ve setup a couple of networks:</p><ul><li>my main network uses WPA Enterprise and authenticates user via AD NPAS to a VLAN (usually User VLAN)</li><li>the IoT network is used by the IoT devices that I have (a Google Home Mini, Chromecast and some other devices)</li><li>the Guest network is used by guests and segmented off so they can&rsquo;t access home/lab network</li></ul><h2 id=vpns>VPNs</h2><p>I have an OpenVPN service running on my router that I can use to access my network from outside. It assigns its clients to <code>10.10.1.0/24</code> and has the same firewall rules as the user network.</p><p>I also have a VPN tunnel to <a href=https://atk-tehdas.com>Osku</a>&rsquo;s network. We used this tutorial to set it up, if you&rsquo;re interested: <a href=https://mitky.com/pfsense-openvpn-site-to-site-vpn/>https://mitky.com/pfsense-openvpn-site-to-site-vpn/</a></p></div></article><footer class="mt-4 mb-8 text-xs text-gray-600"><p>&mdash;&mdash;&mdash;&mdash;&mdash;</p><p>&copy; Taavi Väänänen 2019. All rights reserved.</p><p>Made with
<a href=https://gohugo.io class=link>Hugo</a>,
<a href=https://tailwindcss.com class=link>Tailwind</a>
and a text editor.</p><p>Send your e-mails to mailbox at this domain</p><p>Also view my profile at
<a href=https://github.com/supertassu class=link>github</a>
or
<a href=https://keybase.io/tassu class=link>keybase</a>.</p></footer></div></body></html>